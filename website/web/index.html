<!DOCTYPE html>
<html>
  <head>
    <title>TimeTracker</title>
    <link rel="stylesheet" href="style.css" />
    <script defer src="script_updated.js"></script>
    
    <style>
      /* Placering i grid */
      #side1 { grid-column: 2; grid-row: 1; }
      #side2 { grid-column: 2; grid-row: 2; }
      #side3 { grid-column: 1; grid-row: 2; }
      #side4 { grid-column: 3; grid-row: 2; }
      #side5 { grid-column: 2; grid-row: 3; }
      #side6 { grid-column: 4; grid-row: 2; }
    </style>
  </head>
  <body>  
    <ul class="ul-navbar">
      <li><a class="active" href="index.html">Startpage</a></li>
      <li><a href="statistic.html">Statistic</a></li>
    </ul>

    <div class="banner">
      <h1>Track Your Time</h1>
    </div>

    <!-- Assign Task Section -->
    <div class="box task">
      <h3>Assign Task</h3>
      <select id="task-slot">
        <option value="Task 1">Task 1</option>
        <option value="Task 2">Task 2</option>
        <option value="Task 3">Task 3</option>
        <option value="Task 4">Task 4</option>
        <option value="Task 5">Task 5</option>
        <option value="Task 6">Task 6</option>
      </select>
      <input type="text" id="task-name" placeholder="Enter task name" />
      <button class="btn-primary" id="assign-task">Assign Task</button>
    </div>

    <!-- Statistics Section -->
    <div class="box statistics">
      <h3>Statistics</h3>
      <table class="stats-table">
        <tr><th>Task</th><th>Elapsed Time</th></tr>
        <tbody id="times-table-body"></tbody>
      </table>
      <button class="btn-primary" id="update-times">Update Times</button>
    </div>

    <!-- Updated Previous Tasks Section -->
    <div class="box previous-tasks">
      <h3>Previous Tasks</h3>
      <table class="stats-table">
        <tr><th>Task</th><th>Elapsed Time</th></tr>
        <tbody id="previous-tasks-body"></tbody>
      </table>
    </div>

    <!-- Cube Display -->
    <div class="box cube-layout cube">
      <h3 id="active-task-display">Active: -</h3>
      <div id="side1" class="cube-side">Side 1</div>
      <div id="side2" class="cube-side">Side 2</div>
      <div id="side3" class="cube-side">Side 3</div>
      <div id="side4" class="cube-side">Side 4</div>
      <div id="side5" class="cube-side">Side 5</div>
      <div id="side6" class="cube-side">Side 6</div>
    </div>

    <script>
      const taskToSideId = {
        "Task 1": "side1",
        "Task 2": "side2",
        "Task 3": "side3",
        "Task 4": "side4",
        "Task 5": "side5",
        "Task 6": "side6"
      };

      let lastActiveSide = null;

      function updateActiveSide() {
        fetch('/api/last-task')
          .then(response => response.text())
          .then(text => {
            const lines = text.trim().split("\n");
            const lastLine = lines[lines.length - 1];
            const [task] = lastLine.split(",", 3);

            const sideId = taskToSideId[task.trim()];
            if (sideId && sideId !== lastActiveSide) {
              if (lastActiveSide) {
                const oldEl = document.getElementById(lastActiveSide);
                if (oldEl) oldEl.classList.remove("active");
              }
              const newEl = document.getElementById(sideId);
              if (newEl) newEl.classList.add("active");

              lastActiveSide = sideId;
            }

            document.getElementById("active-task-display").textContent = "Active: " + task.trim();
          })
          .catch(error => console.error("Fel vid uppdatering:", error));
      }

      updateActiveSide();
      setInterval(updateActiveSide, 2000);

      function updatePreviousTasks() {
        fetch('/api/previous-tasks')
          .then(response => response.json())
          .then(data => {
            const tableBody = document.getElementById("previous-tasks-body");
            tableBody.innerHTML = "";

            data.tasks.forEach(task => {
              const row = document.createElement("tr");
              const taskCell = document.createElement("td");
              const elapsedTimeCell = document.createElement("td");

              taskCell.textContent = `${task.task} â€“ ${task.name}`;
              elapsedTimeCell.textContent = task.elapsed_time;

              row.appendChild(taskCell);
              row.appendChild(elapsedTimeCell);
              tableBody.appendChild(row);
            });
          })
          .catch(error => console.error("Error fetching previous tasks:", error));
      }

      updatePreviousTasks();

      document.addEventListener("DOMContentLoaded", () => {
        const assignTaskButton = document.getElementById("assign-task");

        assignTaskButton.replaceWith(assignTaskButton.cloneNode(true));

        document.getElementById("assign-task").addEventListener("click", () => {
          const taskSlot = document.getElementById("task-slot").value;
          const taskName = document.getElementById("task-name").value;

          if (!taskName) {
            alert("Please enter a task name.");
            return;
          }

          fetch('/add_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_slot: taskSlot, task_name: taskName })
          })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => {
                  throw new Error(err.message || "An error occurred while assigning the task.");
                });
              }
              return response.json();
            })
            .then(data => {
              alert(data.message || "Failed to assign task.");
              document.getElementById("task-name").value = "";
              updateTaskDropdown();
              updatePreviousTasks();
            })
            .catch(error => {
              console.error("Error assigning task:", error);
              alert(error.message || "An error occurred while assigning the task.");
            });
        });

        document.getElementById("update-times").addEventListener("click", () => {
          fetch('/get_times')
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => {
                  throw new Error(err.message || "An error occurred while updating times.");
                });
              }
              return response.json();
            })
            .then(data => {
              const tableBody = document.getElementById("times-table-body");
              tableBody.innerHTML = "";

              data.times.forEach(time => {
                const row = document.createElement("tr");
                const taskCell = document.createElement("td");
                const elapsedTimeCell = document.createElement("td");

                taskCell.textContent = time.task;
                elapsedTimeCell.textContent = time.elapsed_time;

                row.appendChild(taskCell);
                row.appendChild(elapsedTimeCell);
                tableBody.appendChild(row);
              });

              updatePreviousTasks();
            })
            .catch(error => {
              console.error("Error updating times:", error);
              alert(error.message || "An error occurred while updating times.");
            });
        });
      });
    </script>
  </body>
</html>
