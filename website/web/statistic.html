<!DOCTYPE html>
<html>
<head>
    <title>Statistic</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="login/loginStyle.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js -->
</head>
<body>
    <ul class="ul-navbar">
        <li><a href="index.html">Startpage</a></li>
        <li><a class="active" href="statistic.html">Statistic</a></li>
        <button class="right login" onclick="document.getElementById('id01').style.display='block'">Login</button>
        <li><a href="devices.html">Devices</a></li>
    </ul>

    <!-- Login Modal -->
    <div id="id01" class="modal">
        <form class="modal-content animate" action="/action_page.php" method="post">
            <div class="imgcontainer">
                <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
                <img src="login/picture1.png" alt="Avatar" class="avatar">
            </div>
            <div class="container">
                <label for="uname"><b>Username</b></label>
                <input type="text" placeholder="Enter Username" name="uname" required>
                <label for="psw"><b>Password</b></label>
                <input type="password" placeholder="Enter Password" name="psw" required>
                <button class="loginbutton" type="submit">Login</button>
                <label>
                    <input type="checkbox" checked="checked" name="remember"> Remember me
                </label>
            </div>
            <div class="container" style="background-color:#f1f1f1">
                <button class="loginbutton" type="button" onclick="document.getElementById('id01').style.display='none'">Cancel</button>
                <span class="psw">Forgot <a href="#">password?</a></span>
            </div>
        </form>
    </div>

    <div class="banner">
        <h1>Statistics</h1>
    </div>

    <!-- Chart Section -->
    <div style="width: 20%; margin: auto;">
        <h2>Time Spent Per Day</h2>
        <canvas id="dailyChart"></canvas>
        <h2>Total Weekly Time</h2>
        <canvas id="pieChart"></canvas>
    </div>

    <script>
        // Fetch data from /api/times and update the charts
        fetch('/api/times')
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.error(data.message);
                    return;
                }

                // Process data to calculate daily hours
                const dailyHours = {};
                let totalTime = 0; // Variable to store the total time
                data.forEach(entry => {
                    const date = new Date(entry.start_time).toLocaleDateString('en-US', { weekday: 'short' });
                    const elapsedTime = entry.elapsed_time.split(':').reduce((acc, time) => (60 * acc) + +time, 0) / 3600; // Convert to hours
                    dailyHours[date] = (dailyHours[date] || 0) + elapsedTime;
                    totalTime += elapsedTime; // Add to total time
                });

                const dailyLabels = Object.keys(dailyHours);
                const dailyData = Object.values(dailyHours);

                // Update bar chart
                new Chart(document.getElementById('dailyChart'), {
                    type: 'bar',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'Time Spent (hours)',
                            data: dailyData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Update pie chart with total time in the title
                new Chart(document.getElementById('pieChart'), {
                    type: 'pie',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            data: dailyData,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#D3D3D3'
                            ]
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            title: {
                                display: true,
                                text: `Total Weekly Time: ${totalTime.toFixed(2)} hours` // Add total time to the title
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching times:', error));
    </script>
</body>
</html>
