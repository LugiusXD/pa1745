<!DOCTYPE html>
<html>
<head>
    <title>Statistic</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="login/loginStyle.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js -->
</head>
<body>
    <ul class="ul-navbar">
        <li><a href="index.html">Startpage</a></li>
        <li><a class="active" href="statistic.html">Statistic</a></li>
        <button class="right login" onclick="document.getElementById('id01').style.display='block'">Login</button>
        <li><a href="devices.html">Devices</a></li>
    </ul>

    <!-- Login Modal -->
    <div id="id01" class="modal">
        <form class="modal-content animate" action="/action_page.php" method="post">
            <div class="imgcontainer">
                <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
                <img src="login/picture1.png" alt="Avatar" class="avatar">
            </div>
            <div class="container">
                <label for="uname"><b>Username</b></label>
                <input type="text" placeholder="Enter Username" name="uname" required>
                <label for="psw"><b>Password</b></label>
                <input type="password" placeholder="Enter Password" name="psw" required>
                <button class="loginbutton" type="submit">Login</button>
                <label>
                    <input type="checkbox" checked="checked" name="remember"> Remember me
                </label>
            </div>
            <div class="container" style="background-color:#f1f1f1">
                <button class="loginbutton" type="button" onclick="document.getElementById('id01').style.display='none'">Cancel</button>
                <span class="psw">Forgot <a href="#">password?</a></span>
            </div>
        </form>
    </div>

    <div class="banner">
        <h1>Statistics</h1>
    </div>

    <!-- Chart Section -->
    <div style="width: 20%; margin: auto;">
        <h2>Time Spent Per Day</h2>
        <canvas id="dailyChart"></canvas>
        <h2>Total Weekly Time</h2>
        <canvas id="pieChart"></canvas>
    </div>

    <script>
        // Fetch data from /api/times and update the charts
        fetch('/api/times')
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.error(data.message);
                    return;
                }

                // Fetch task aliases
                fetch('/get_task_aliases')
                    .then(response => response.json())
                    .then(taskAliases => {
                        // Process data to calculate hours per task per day
                        const taskDayData = {};
                        const taskColors = {
                            "Task 1": "#FF6384",
                            "Task 2": "#36A2EB",
                            "Task 3": "#FFCE56",
                            "Task 4": "#4BC0C0",
                            "Task 5": "#9966FF",
                            "Task 6": "#FF9F40"
                        };

                        data.forEach(entry => {
                            const date = new Date(entry.start_time).toLocaleDateString('en-US', { weekday: 'short' });
                            const task = entry.task; // Use the original task name
                            const elapsedTime = entry.elapsed_time.split(':').reduce((acc, time) => (60 * acc) + +time, 0) / 3600; // Convert to hours

                            if (!taskDayData[date]) {
                                taskDayData[date] = {};
                            }
                            taskDayData[date][task] = (taskDayData[date][task] || 0) + elapsedTime;
                        });

                        const dailyLabels = Object.keys(taskDayData);
                        const taskNames = [...new Set(data.map(entry => entry.task))]; // Get unique task names

                        // Prepare datasets for the stacked bar chart
                        const datasets = taskNames.map(task => {
                            const alias = taskAliases[task]?.alias || task; // Display alias if available
                            const defaultTask = taskAliases[task]?.default || task; // Resolve to default task name
                            return {
                                label: alias, // Display the alias
                                data: dailyLabels.map(date => taskDayData[date]?.[task] || 0),
                                backgroundColor: taskColors[defaultTask] || '#FF6384' // Use default task for color
                            };
                        });

                        // Create the stacked bar chart
                        new Chart(document.getElementById('dailyChart'), {
                            type: 'bar',
                            data: {
                                labels: dailyLabels,
                                datasets: datasets
                            },
                            options: {
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Time Spent Per Task Per Day'
                                    },
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                responsive: true,
                                scales: {
                                    x: {
                                        stacked: true
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Hours'
                                        }
                                    }
                                }
                            }
                        });

                        // Calculate total time for the pie chart
                        const totalTime = Object.values(taskDayData).reduce((sum, day) => {
                            return sum + Object.values(day).reduce((daySum, hours) => daySum + hours, 0);
                        }, 0);

                        // Create the pie chart
                        new Chart(document.getElementById('pieChart'), {
                            type: 'pie',
                            data: {
                                labels: taskNames.map(task => taskAliases[task]?.alias || task), // Display aliases
                                datasets: [{
                                    data: taskNames.map(task => {
                                        return Object.values(taskDayData).reduce((sum, day) => sum + (day[task] || 0), 0);
                                    }),
                                    backgroundColor: taskNames.map(task => {
                                        const defaultTask = taskAliases[task]?.default || task; // Resolve to default task name
                                        return taskColors[defaultTask] || '#FF6384'; // Use default task for color
                                    })
                                }]
                            },
                            options: {
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    },
                                    title: {
                                        display: true,
                                        text: `Total Weekly Time: ${totalTime.toFixed(2)} hours`
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching task aliases:', error));
            })
            .catch(error => console.error('Error fetching times:', error));
    </script>
</body>
</html>
